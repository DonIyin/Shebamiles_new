<!DOCTYPE html>
<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Attendance Tracking</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="index.css" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f97316",
                        "primary-dark": "#ea580c",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101822",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                },
            },
        }
    </script>
<style type="text/tailwindcss">
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        :root { --primary-color: #f97316; }
        .status-badge {
            transition: all 0.3s ease;
        }
        .status-present { @apply bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400; }
        .status-absent { @apply bg-rose-100 text-rose-800 dark:bg-rose-900/30 dark:text-rose-400; }
        .status-late { @apply bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400; }
        .status-half_day { @apply bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400; }
        .status-on_leave { @apply bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400; }
    </style>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800;900&amp;display=swap" rel="stylesheet"/>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 min-h-screen">
<div class="p-8 max-w-[1400px] mx-auto w-full">
<div class="mb-8">
    <h1 class="text-3xl font-bold mb-2">Attendance Tracking & Calendar</h1>
    <p class="text-slate-500 dark:text-slate-400">Track and manage employee attendance</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
<div class="lg:col-span-3">
<div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6">
<div class="flex items-center justify-between mb-6">
    <h2 class="text-xl font-bold">Attendance Records</h2>
    <div class="flex gap-2">
        <input type="month" id="monthPicker" class="px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm"/>
        <select id="employeeFilter" class="px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm">
            <option value="">All Employees</option>
        </select>
    </div>
</div>

<div class="overflow-x-auto">
<table class="w-full text-sm">
    <thead>
        <tr class="border-b border-slate-200 dark:border-slate-700">
            <th class="px-6 py-3 text-left font-semibold text-slate-600 dark:text-slate-400">Employee</th>
            <th class="px-6 py-3 text-left font-semibold text-slate-600 dark:text-slate-400">Date</th>
            <th class="px-6 py-3 text-left font-semibold text-slate-600 dark:text-slate-400">Status</th>
            <th class="px-6 py-3 text-left font-semibold text-slate-600 dark:text-slate-400">Check In</th>
            <th class="px-6 py-3 text-left font-semibold text-slate-600 dark:text-slate-400">Check Out</th>
            <th class="px-6 py-3 text-left font-semibold text-slate-600 dark:text-slate-400">Notes</th>
            <th class="px-6 py-3 text-left font-semibold text-slate-600 dark:text-slate-400">Action</th>
        </tr>
    </thead>
    <tbody id="attendanceTableBody">
        <tr class="border-b border-slate-200 dark:border-slate-700">
            <td colspan="7" class="px-6 py-4 text-center text-slate-400">Loading...</td>
        </tr>
    </tbody>
</table>
</div>
</div>
</div>

<div class="lg:col-span-1">
<div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6">
<h3 class="font-bold mb-4">Attendance Summary</h3>
<div class="space-y-3 text-sm">
    <div class="flex justify-between">
        <span class="text-slate-600 dark:text-slate-400">Present</span>
        <span class="font-bold text-emerald-600" id="presentCount">0</span>
    </div>
    <div class="flex justify-between">
        <span class="text-slate-600 dark:text-slate-400">Absent</span>
        <span class="font-bold text-rose-600" id="absentCount">0</span>
    </div>
    <div class="flex justify-between">
        <span class="text-slate-600 dark:text-slate-400">Late</span>
        <span class="font-bold text-amber-600" id="lateCount">0</span>
    </div>
    <div class="flex justify-between">
        <span class="text-slate-600 dark:text-slate-400">On Leave</span>
        <span class="font-bold text-purple-600" id="leaveCount">0</span>
    </div>
</div>
</div>
</div>
</div>
</div>

<script src="index.js"></script>
<script src="auth-utils.js"></script>
<script>
    // Verify user is admin
    if (!AuthUtils.requireAdmin()) {
        throw new Error('Admin access required');
    }
    
    const monthPicker = document.getElementById('monthPicker');
    const employeeFilter = document.getElementById('employeeFilter');
    const tableBody = document.getElementById('attendanceTableBody');

    // Set current month
    monthPicker.valueAsDate = new Date();

    async function loadAttendance() {
        const month = monthPicker.value;
        const employeeId = employeeFilter.value;
        
        try {
            let url = `../backend/attendance_api.php?month=${month}`;
            if (employeeId) url += `&employee_id=${employeeId}`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success) {
                renderAttendanceTable(data.records);
                updateSummary(data.records);
            }
        } catch (error) {
            console.error('Error loading attendance:', error);
        }
    }

    function renderAttendanceTable(records) {
        if (records.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-slate-400">No records found</td></tr>';
            return;
        }

        tableBody.innerHTML = records.map(record => `
            <tr class="border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50">
                <td class="px-6 py-4 font-medium">${record.first_name} ${record.last_name}</td>
                <td class="px-6 py-4">${new Date(record.date).toLocaleDateString()}</td>
                <td class="px-6 py-4">
                    <span class="status-badge status-${record.status} px-3 py-1 rounded-full text-xs font-semibold">
                        ${record.status.replace('_', ' ').charAt(0).toUpperCase() + record.status.replace('_', ' ').slice(1)}
                    </span>
                </td>
                <td class="px-6 py-4">${record.check_in || '-'}</td>
                <td class="px-6 py-4">${record.check_out || '-'}</td>
                <td class="px-6 py-4 text-slate-600 dark:text-slate-400">${record.notes || '-'}</td>
                <td class="px-6 py-4">
                    <button onclick="editRecord(${record.attendance_id})" class="text-primary hover:text-primary-dark text-sm font-medium">Edit</button>
                </td>
            </tr>
        `).join('');
    }

    function updateSummary(records) {
        const summary = {
            present: 0,
            absent: 0,
            late: 0,
            on_leave: 0
        };

        records.forEach(r => {
            if (r.status === 'present' || r.status === 'half_day') summary.present++;
            else if (r.status === 'absent') summary.absent++;
            else if (r.status === 'late') summary.late++;
            else if (r.status === 'on_leave') summary.on_leave++;
        });

        document.getElementById('presentCount').textContent = summary.present;
        document.getElementById('absentCount').textContent = summary.absent;
        document.getElementById('lateCount').textContent = summary.late;
        document.getElementById('leaveCount').textContent = summary.on_leave;
    }

    async function loadEmployees() {
        try {
            const response = await fetch('../backend/get_employees.php');
            const data = await response.json();
            
            if (data.success) {
                employeeFilter.innerHTML = '<option value="">All Employees</option>';
                data.employees.forEach(emp => {
                    employeeFilter.innerHTML += `<option value="${emp.id}">${emp.full_name}</option>`;
                });
            }
        } catch (error) {
            console.error('Error loading employees:', error);
        }
    }

    let currentEditingRecord = null;

    async function editRecord(attendanceId) {
        try {
            // Find the record in the current table
            const response = await fetch(`../backend/attendance_api.php?id=${attendanceId}`);
            const data = await response.json();
            
            if (!data.success) {
                showToast('Unable to load record details', 'error');
                return;
            }

            currentEditingRecord = data.record;
            
            // Populate the edit modal
            document.getElementById('editAttendanceId').value = attendanceId;
            document.getElementById('editEmployeeName').value = `${data.record.first_name} ${data.record.last_name}`;
            document.getElementById('editDate').value = data.record.date;
            document.getElementById('editStatus').value = data.record.status;
            document.getElementById('editCheckIn').value = data.record.check_in || '';
            document.getElementById('editCheckOut').value = data.record.check_out || '';
            document.getElementById('editNotes').value = data.record.notes || '';
            
            // Show the modal
            document.getElementById('editAttendanceModal').classList.remove('hidden');
            document.getElementById('editAttendanceModal').classList.add('flex');
        } catch (error) {
            console.error('Error loading record:', error);
            showToast('Error loading record details', 'error');
        }
    }

    function closeEditModal() {
        document.getElementById('editAttendanceModal').classList.add('hidden');
        document.getElementById('editAttendanceModal').classList.remove('flex');
        currentEditingRecord = null;
    }

    document.getElementById('editAttendanceForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const updateData = {
            attendance_id: parseInt(document.getElementById('editAttendanceId').value),
            status: document.getElementById('editStatus').value,
            check_in: document.getElementById('editCheckIn').value || null,
            check_out: document.getElementById('editCheckOut').value || null,
            notes: document.getElementById('editNotes').value || null
        };

        // Validation
        if (!updateData.status) {
            showToast('Please select a status', 'error');
            return;
        }

        try {
            const response = await fetch('../backend/attendance_api.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            });

            const result = await response.json();
            if (result.success) {
                showToast('Attendance record updated successfully!', 'success');
                closeEditModal();
                loadAttendance(); // Reload the table
            } else {
                showToast(result.message || 'Error updating record', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error updating record', 'error');
        }
    });

    monthPicker.addEventListener('change', loadAttendance);
    employeeFilter.addEventListener('change', loadAttendance);

    // Initial load
    loadEmployees();
    loadAttendance();
</script>

<!-- Edit Attendance Modal -->
<div id="editAttendanceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-xl max-w-md w-full mx-4">
        <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-800">
            <h3 class="text-lg font-bold">Edit Attendance Record</h3>
            <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <form id="editAttendanceForm" class="p-6 space-y-4">
            <input type="hidden" id="editAttendanceId"/>

            <div>
                <label class="block text-sm font-medium mb-2">Employee</label>
                <input type="text" id="editEmployeeName" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-500 cursor-not-allowed" disabled/>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Date</label>
                <input type="date" id="editDate" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-500 cursor-not-allowed" disabled/>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Status</label>
                <select id="editStatus" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800">
                    <option value="">Select Status</option>
                    <option value="present">Present</option>
                    <option value="absent">Absent</option>
                    <option value="late">Late</option>
                    <option value="half_day">Half Day</option>
                    <option value="on_leave">On Leave</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Check In Time</label>
                <input type="time" id="editCheckIn" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800"/>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Check Out Time</label>
                <input type="time" id="editCheckOut" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800"/>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Notes</label>
                <textarea id="editNotes" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800" rows="3"></textarea>
            </div>

            <div class="flex gap-3 pt-4">
                <button type="submit" class="flex-1 bg-primary text-white py-2 rounded-lg font-medium hover:bg-primary-dark transition">Save Changes</button>
                <button type="button" onclick="closeEditModal()" class="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-white py-2 rounded-lg font-medium hover:bg-slate-300 dark:hover:bg-slate-600 transition">Cancel</button>
            </div>
        </form>
    </div>
</div>

</body></html>
