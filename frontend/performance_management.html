<!DOCTYPE html>
<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Performance Management</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="index.css" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f97316",
                        "primary-dark": "#ea580c",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101822",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                },
            },
        }
    </script>
<style type="text/tailwindcss">
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        :root { --primary-color: #f97316; }
        .rating-badge { @apply inline-flex items-center justify-center w-12 h-12 rounded-full font-bold text-white; }
        .rating-excellent { @apply bg-emerald-500; }
        .rating-good { @apply bg-blue-500; }
        .rating-average { @apply bg-amber-500; }
        .rating-poor { @apply bg-rose-500; }
    </style>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800;900&amp;display=swap" rel="stylesheet"/>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 min-h-screen">
<div class="p-8 max-w-[1400px] mx-auto w-full">
<div class="mb-8">
    <h1 class="text-3xl font-bold mb-2">Performance Management</h1>
    <p class="text-slate-500 dark:text-slate-400">Track and manage employee performance reviews</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
<div class="lg:col-span-3">
<div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6">
<div class="flex items-center justify-between mb-6">
    <h2 class="text-xl font-bold">Performance Reviews</h2>
    <button onclick="showReviewModal()" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary-dark flex items-center gap-2">
        <span class="material-symbols-outlined text-sm">add</span>New Review
    </button>
</div>

<div class="space-y-4" id="reviewsList">
    <div class="text-center py-8 text-slate-400">Loading reviews...</div>
</div>
</div>
</div>

<div class="lg:col-span-1">
<div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6 h-fit sticky top-8">
<h3 class="font-bold mb-4">Performance Stats</h3>
<div class="space-y-3 text-sm">
    <div>
        <div class="flex justify-between mb-1">
            <span class="text-slate-600 dark:text-slate-400">Excellent (4-5)</span>
            <span class="font-bold" id="excellentCount">0</span>
        </div>
        <div class="w-full bg-slate-200 dark:bg-slate-700 h-2 rounded-full">
            <div class="bg-emerald-500 h-2 rounded-full" id="excellentBar" style="width: 0%"></div>
        </div>
    </div>
    <div>
        <div class="flex justify-between mb-1">
            <span class="text-slate-600 dark:text-slate-400">Good (3-4)</span>
            <span class="font-bold" id="goodCount">0</span>
        </div>
        <div class="w-full bg-slate-200 dark:bg-slate-700 h-2 rounded-full">
            <div class="bg-blue-500 h-2 rounded-full" id="goodBar" style="width: 0%"></div>
        </div>
    </div>
    <div>
        <div class="flex justify-between mb-1">
            <span class="text-slate-600 dark:text-slate-400">Average (2-3)</span>
            <span class="font-bold" id="averageCount">0</span>
        </div>
        <div class="w-full bg-slate-200 dark:bg-slate-700 h-2 rounded-full">
            <div class="bg-amber-500 h-2 rounded-full" id="averageBar" style="width: 0%"></div>
        </div>
    </div>
    <div>
        <div class="flex justify-between mb-1">
            <span class="text-slate-600 dark:text-slate-400">Below Avg (&lt;2)</span>
            <span class="font-bold" id="poorCount">0</span>
        </div>
        <div class="w-full bg-slate-200 dark:bg-slate-700 h-2 rounded-full">
            <div class="bg-rose-500 h-2 rounded-full" id="poorBar" style="width: 0%"></div>
        </div>
    </div>
</div>
</div>
</div>
</div>
</div>

<!-- Performance Review Modal -->
<div id="reviewModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 overflow-y-auto">
<div class="bg-white dark:bg-slate-900 rounded-xl max-w-2xl w-full mx-4 my-8 p-6">
    <h3 class="text-xl font-bold mb-6">New Performance Review</h3>
    <form onsubmit="submitReview(event)" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium mb-2">Employee</label>
                <select id="reviewEmployeeSelect" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800" required>
                    <option value="">Select Employee</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Review Period</label>
                <input type="text" id="reviewPeriod" placeholder="Q1 2024" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800" required/>
            </div>
        </div>

        <div class="grid grid-cols-5 gap-3">
            <div>
                <label class="block text-xs font-medium mb-2">Overall Rating</label>
                <input type="number" id="overallRating" min="0" max="5" step="0.1" placeholder="0-5" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm" required/>
            </div>
            <div>
                <label class="block text-xs font-medium mb-2">Productivity</label>
                <input type="number" id="productivityScore" min="0" max="100" placeholder="0-100" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm"/>
            </div>
            <div>
                <label class="block text-xs font-medium mb-2">Quality</label>
                <input type="number" id="qualityScore" min="0" max="100" placeholder="0-100" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm"/>
            </div>
            <div>
                <label class="block text-xs font-medium mb-2">Teamwork</label>
                <input type="number" id="teamworkScore" min="0" max="100" placeholder="0-100" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm"/>
            </div>
            <div>
                <label class="block text-xs font-medium mb-2">Communication</label>
                <input type="number" id="communicationScore" min="0" max="100" placeholder="0-100" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm"/>
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium mb-2">Strengths</label>
            <textarea id="strengthsText" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm" rows="2" placeholder="List key strengths..."></textarea>
        </div>

        <div>
            <label class="block text-sm font-medium mb-2">Areas for Improvement</label>
            <textarea id="improvementText" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm" rows="2" placeholder="List areas to improve..."></textarea>
        </div>

        <div>
            <label class="block text-sm font-medium mb-2">Comments</label>
            <textarea id="commentsText" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm" rows="2" placeholder="Additional comments..."></textarea>
        </div>

        <div class="flex gap-2 pt-4">
            <button type="button" onclick="hideReviewModal()" class="flex-1 px-4 py-2 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-800">Cancel</button>
            <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary-dark">Submit Review</button>
        </div>
    </form>
</div>
</div>

<script src="index.js"></script>
<script src="auth-utils.js"></script>
<script>
    // Verify user is admin
    if (!AuthUtils.requireAdmin()) {
        throw new Error('Admin access required');
    }
    
    async function loadPerformanceReviews() {
        try {
            const response = await fetch('../backend/performance_api.php');
            const data = await response.json();
            
            if (data.success) {
                renderReviews(data.reviews);
                updateStats(data.reviews);
            }
        } catch (error) {
            console.error('Error loading reviews:', error);
        }
    }

    function renderReviews(reviews) {
        const reviewsList = document.getElementById('reviewsList');
        
        if (reviews.length === 0) {
            reviewsList.innerHTML = '<div class="text-center py-8 text-slate-400">No reviews found</div>';
            return;
        }

        reviewsList.innerHTML = reviews.map(review => {
            const ratingClass = review.rating >= 4 ? 'rating-excellent' : 
                               review.rating >= 3 ? 'rating-good' : 
                               review.rating >= 2 ? 'rating-average' : 'rating-poor';
            
            return `
                <div class="border border-slate-200 dark:border-slate-800 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h4 class="font-bold">${review.first_name} ${review.last_name}</h4>
                            <p class="text-sm text-slate-500">${review.review_period}</p>
                        </div>
                        <div class="text-right">
                            <div class="rating-badge ${ratingClass}">${review.rating}</div>
                            <p class="text-xs text-slate-400 mt-1">Reviewer: ${review.reviewer_first_name} ${review.reviewer_last_name}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3 text-sm">
                        ${review.productivity_score ? `<div><span class="text-slate-600 dark:text-slate-400">Productivity:</span> <span class="font-semibold">${review.productivity_score}%</span></div>` : ''}
                        ${review.quality_score ? `<div><span class="text-slate-600 dark:text-slate-400">Quality:</span> <span class="font-semibold">${review.quality_score}%</span></div>` : ''}
                        ${review.teamwork_score ? `<div><span class="text-slate-600 dark:text-slate-400">Teamwork:</span> <span class="font-semibold">${review.teamwork_score}%</span></div>` : ''}
                        ${review.communication_score ? `<div><span class="text-slate-600 dark:text-slate-400">Communication:</span> <span class="font-semibold">${review.communication_score}%</span></div>` : ''}
                    </div>

                    ${review.comments ? `<p class="text-sm text-slate-600 dark:text-slate-400 mb-2"><strong>Comments:</strong> ${review.comments}</p>` : ''}
                    
                    <div class="flex gap-2 pt-3 border-t border-slate-200 dark:border-slate-700">
                        <button onclick="editReview(${review.performance_id})" class="text-primary hover:text-primary-dark text-sm font-medium">Edit</button>
                        <button onclick="deleteReview(${review.performance_id})" class="text-rose-600 hover:text-rose-700 text-sm font-medium">Delete</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateStats(reviews) {
        let excellent = 0, good = 0, average = 0, poor = 0;
        const total = reviews.length;

        reviews.forEach(r => {
            if (r.rating >= 4) excellent++;
            else if (r.rating >= 3) good++;
            else if (r.rating >= 2) average++;
            else poor++;
        });

        document.getElementById('excellentCount').textContent = excellent;
        document.getElementById('goodCount').textContent = good;
        document.getElementById('averageCount').textContent = average;
        document.getElementById('poorCount').textContent = poor;

        if (total > 0) {
            document.getElementById('excellentBar').style.width = (excellent / total * 100) + '%';
            document.getElementById('goodBar').style.width = (good / total * 100) + '%';
            document.getElementById('averageBar').style.width = (average / total * 100) + '%';
            document.getElementById('poorBar').style.width = (poor / total * 100) + '%';
        }
    }

    async function loadEmployees() {
        try {
            const response = await fetch('../backend/get_employees.php');
            const data = await response.json();
            
            if (data.success) {
                const select = document.getElementById('reviewEmployeeSelect');
                select.innerHTML = '<option value="">Select Employee</option>';
                data.employees.forEach(emp => {
                    select.innerHTML += `<option value="${emp.id}">${emp.full_name}</option>`;
                });
            }
        } catch (error) {
            console.error('Error loading employees:', error);
        }
    }

    function showReviewModal() {
        document.getElementById('reviewModal').classList.remove('hidden');
    }

    function hideReviewModal() {
        document.getElementById('reviewModal').classList.add('hidden');
    }

    async function submitReview(event) {
        event.preventDefault();
        
        const employeeId = document.getElementById('reviewEmployeeSelect').value;
        const period = document.getElementById('reviewPeriod').value;
        const rating = parseFloat(document.getElementById('overallRating').value);

        try {
            const response = await fetch('../backend/performance_api.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    employee_id: parseInt(employeeId),
                    review_period: period,
                    rating: rating,
                    productivity_score: parseInt(document.getElementById('productivityScore').value) || null,
                    quality_score: parseInt(document.getElementById('qualityScore').value) || null,
                    teamwork_score: parseInt(document.getElementById('teamworkScore').value) || null,
                    communication_score: parseInt(document.getElementById('communicationScore').value) || null,
                    strengths: document.getElementById('strengthsText').value,
                    areas_for_improvement: document.getElementById('improvementText').value,
                    comments: document.getElementById('commentsText').value
                })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Review submitted successfully!', 'success');
                hideReviewModal();
                loadPerformanceReviews();
                event.target.reset();
            } else {
                showToast(data.message || 'Error submitting review', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error submitting review', 'error');
        }
    }

    function editReview(reviewId) {
        loadReviewForEdit(reviewId);
    }

    async function loadReviewForEdit(reviewId) {
        try {
            const response = await fetch(`../backend/performance_api.php?id=${reviewId}`);
            const data = await response.json();
            
            if (data.success) {
                const review = data.review;
                
                // Populate the edit modal
                document.getElementById('editReviewId').value = reviewId;
                document.getElementById('editReviewEmployee').textContent = `${review.first_name} ${review.last_name}`;
                document.getElementById('editReviewPeriod').value = review.review_period;
                document.getElementById('editOverallRating').value = review.rating;
                document.getElementById('editProductivityScore').value = review.productivity_score || '';
                document.getElementById('editQualityScore').value = review.quality_score || '';
                document.getElementById('editTeamworkScore').value = review.teamwork_score || '';
                document.getElementById('editCommunicationScore').value = review.communication_score || '';
                document.getElementById('editStrengthsText').value = review.strengths || '';
                document.getElementById('editImprovementText').value = review.areas_for_improvement || '';
                document.getElementById('editCommentsText').value = review.comments || '';
                
                // Show the modal
                document.getElementById('editReviewModal').classList.remove('hidden');
                document.getElementById('editReviewModal').classList.add('flex');
            } else {
                showToast('Unable to load review details', 'error');
            }
        } catch (error) {
            console.error('Error loading review:', error);
            showToast('Error loading review details', 'error');
        }
    }

    function closeEditReviewModal() {
        document.getElementById('editReviewModal').classList.add('hidden');
        document.getElementById('editReviewModal').classList.remove('flex');
    }

    async function submitEditReview(event) {
        event.preventDefault();
        
        const reviewId = document.getElementById('editReviewId').value;
        const rating = parseFloat(document.getElementById('editOverallRating').value);

        if (!rating || rating < 0 || rating > 5) {
            showToast('Rating must be between 0 and 5', 'error');
            return;
        }

        try {
            const response = await fetch('../backend/performance_api.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    performance_id: parseInt(reviewId),
                    review_period: document.getElementById('editReviewPeriod').value,
                    rating: rating,
                    productivity_score: parseInt(document.getElementById('editProductivityScore').value) || null,
                    quality_score: parseInt(document.getElementById('editQualityScore').value) || null,
                    teamwork_score: parseInt(document.getElementById('editTeamworkScore').value) || null,
                    communication_score: parseInt(document.getElementById('editCommunicationScore').value) || null,
                    strengths: document.getElementById('editStrengthsText').value,
                    areas_for_improvement: document.getElementById('editImprovementText').value,
                    comments: document.getElementById('editCommentsText').value
                })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Review updated successfully!', 'success');
                closeEditReviewModal();
                loadPerformanceReviews();
            } else {
                showToast(data.message || 'Error updating review', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error updating review', 'error');
        }
    }

    function deleteReview(reviewId) {
        const confirmDialog = document.getElementById('deleteConfirmDialog');
        document.getElementById('deleteReviewId').value = reviewId;
        confirmDialog.classList.remove('hidden');
        confirmDialog.classList.add('flex');
    }

    function closeDeleteDialog() {
        document.getElementById('deleteConfirmDialog').classList.add('hidden');
        document.getElementById('deleteConfirmDialog').classList.remove('flex');
    }

    async function confirmDeleteReview() {
        const reviewId = document.getElementById('deleteReviewId').value;
        
        try {
            const response = await fetch('../backend/performance_api.php', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    performance_id: parseInt(reviewId)
                })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Review deleted successfully!', 'success');
                closeDeleteDialog();
                loadPerformanceReviews();
            } else {
                showToast(data.message || 'Error deleting review', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error deleting review', 'error');
        }
    }

    statusFilter.addEventListener('change', loadPerformanceReviews);

    // Initial load
    loadEmployees();
    loadPerformanceReviews();
</script>

<!-- Edit Review Modal -->
<div id="editReviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-800 sticky top-0 bg-white dark:bg-slate-900">
            <h3 class="text-lg font-bold">Edit Performance Review</h3>
            <button onclick="closeEditReviewModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <form id="editReviewForm" onsubmit="submitEditReview(event)" class="p-6 space-y-4">
            <input type="hidden" id="editReviewId"/>

            <div>
                <label class="block text-sm font-medium mb-2">Employee</label>
                <p class="text-lg font-semibold" id="editReviewEmployee">-</p>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Review Period</label>
                <input type="text" id="editReviewPeriod" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800" placeholder="Q1 2024" required/>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Overall Rating (0-5)</label>
                <input type="number" id="editOverallRating" min="0" max="5" step="0.1" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800" required/>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Productivity Score (0-100)</label>
                    <input type="number" id="editProductivityScore" min="0" max="100" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800"/>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Quality Score (0-100)</label>
                    <input type="number" id="editQualityScore" min="0" max="100" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800"/>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Teamwork Score (0-100)</label>
                    <input type="number" id="editTeamworkScore" min="0" max="100" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800"/>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Communication Score (0-100)</label>
                    <input type="number" id="editCommunicationScore" min="0" max="100" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800"/>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Strengths</label>
                <textarea id="editStrengthsText" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm" rows="2" placeholder="List key strengths..."></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Areas for Improvement</label>
                <textarea id="editImprovementText" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm" rows="2" placeholder="List areas to improve..."></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Comments</label>
                <textarea id="editCommentsText" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm" rows="2" placeholder="Additional comments..."></textarea>
            </div>

            <div class="flex gap-2 pt-4 border-t border-slate-200 dark:border-slate-800">
                <button type="button" onclick="closeEditReviewModal()" class="flex-1 px-4 py-2 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-800">Cancel</button>
                <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary-dark">Update Review</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Dialog -->
<div id="deleteConfirmDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-xl max-w-sm w-full mx-4">
        <div class="p-6">
            <h3 class="text-lg font-bold mb-2">Delete Performance Review?</h3>
            <p class="text-slate-600 dark:text-slate-400 mb-6">This action cannot be undone. Are you sure you want to delete this review?</p>
            
            <input type="hidden" id="deleteReviewId"/>
            
            <div class="flex gap-3">
                <button type="button" onclick="closeDeleteDialog()" class="flex-1 px-4 py-2 border border-slate-200 dark:border-slate-700 rounded-lg font-medium hover:bg-slate-50 dark:hover:bg-slate-800">Cancel</button>
                <button type="button" onclick="confirmDeleteReview()" class="flex-1 px-4 py-2 bg-rose-600 text-white rounded-lg font-medium hover:bg-rose-700">Delete</button>
            </div>
        </div>
    </div>
</div>

</body></html>
